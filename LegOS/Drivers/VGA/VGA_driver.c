#include "../../include/VGA_driver.h"
#include "../../include/stringlib.h"

// VGA ports
#define VGA_SEQ_INDEX   0x3C4
#define VGA_SEQ_DATA    0x3C5
#define VGA_CRTC_INDEX  0x3D4
#define VGA_CRTC_DATA   0x3D5
#define VGA_GC_INDEX    0x3CE
#define VGA_GC_DATA     0x3CF
#define VGA_AC_INDEX    0x3C0
#define VGA_AC_WRITE    0x3C0
#define VGA_AC_READ     0x3C1
#define VGA_MISC_WRITE  0x3C2
#define VGA_MISC_READ   0x3CC
#define VGA_DAC_WRITE   0x3C8
#define VGA_DAC_READ    0x3C7
#define VGA_DAC_DATA    0x3C9
#define VGA_DAC_STATE   0x3C7
#define	VGA_INSTAT_READ	0x3DA

#define	VGA_NUM_SEQ_REGS	5
#define	VGA_NUM_CRTC_REGS	25
#define	VGA_NUM_GC_REGS		9
#define	VGA_NUM_AC_REGS		21
#define	VGA_NUM_REGS		(1 + VGA_NUM_SEQ_REGS + VGA_NUM_CRTC_REGS + \ VGA_NUM_GC_REGS + VGA_NUM_AC_REGS)


// VGA graphics framebuffer address
#define VGA_FRAMEBUFFER 0xA0000

// outport and import functions
static inline void outportb(uint16_t port, uint8_t value) {
    asm volatile ("outb %0, %1" : : "a"(value), "Nd"(port));
}

static inline uint8_t inportb(uint16_t port) {
    uint8_t ret;
    asm volatile ("inb %1, %0" : "=a"(ret) : "Nd"(port));
    return ret;
}

unsigned char g_320x200x256[] =
{
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x01, 0x0F, 0x00, 0x0E,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x28,	0x40, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x41, 0x00, 0x0F, 0x00,	0x00
};

unsigned char R[256] = {
	0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xC0, 0x80, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, //   0 - 15
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  16 - 31
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  32 - 47
	0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, //  48 - 63
	0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, //  64 - 79
	0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, //  80 - 95
	0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, //  96 - 111 
	0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, // 112 - 127
	0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, // 128 - 143
	0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, // 144 - 159
	0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, // 160 - 175 
	0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, // 176 - 191
	0xD7, 0xD7, 0xD7, 0xD7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // 192 - 207
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // 208 - 223
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x08, 0x12, 0x1C, 0x26, 0x30, 0x3A, 0x44, 0x4E, // 224 - 239
	0x58, 0x62, 0x6C, 0x76, 0x80, 0x8A, 0x94, 0x9E, 0xA8, 0xB2, 0xBC, 0xC6, 0xD0, 0xDA, 0xE4, 0xEE	// 240 - 255
}; 

unsigned char G[256] = {
	0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0xC0, 0x80, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, //   0 - 15
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x87, 0x87, 0x87, 0x87, //  16 - 31 
	0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xFF, 0xFF, //  32 - 47
	0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, //  48 - 63
	0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xD7, 0xD7, 0xD7, 0xD7, //  64 - 79
	0xD7, 0xD7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, //  80 - 95
	0x5F, 0x5F, 0x5F, 0x5F, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, //  96 - 111
	0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, // 112 - 127
	0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0xAF, 0xAF, // 128 - 143
	0xAF, 0xAF, 0xAF, 0xAF, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, // 144 - 159
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x87, 0x87, 0x87, 0x87, // 160 - 175
	0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xD7, 0xFF, 0xFF, // 176 - 191
	0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, // 192 - 207
	0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0xD7, 0xD7, 0xD7, 0xD7, // 208 - 223
	0xD7, 0xD7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x08, 0x12, 0x1C, 0x26, 0x30, 0x3A, 0x44, 0x4E, // 224 - 239
	0x58, 0x62, 0x6C, 0x76, 0x80, 0x8A, 0x94, 0x9E, 0xA8, 0xB2, 0xBC, 0xC6, 0xD0, 0xDA, 0xE4, 0xEE	// 240 - 255
};

unsigned char B[256] = {
	0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xC0, 0x80, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, //   0 - 15
	0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, //  16 - 31
	0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, //  32 - 47
	0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, //  48 - 63
	0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, //  64 - 79
	0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, //  80 - 95
	0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, //  96 - 111
	0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, // 112 - 127
	0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, // 128 - 143
	0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, // 144 - 159
	0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, // 160 - 175
	0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, // 176 - 191
	0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, // 192 - 207
	0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, // 208 - 223
	0xD7, 0xFF, 0x00, 0x5F, 0x87, 0xAF, 0xD7, 0xFF, 0x08, 0x12, 0x1C, 0x26, 0x30, 0x3A, 0x44, 0x4E, // 224 - 239
	0x58, 0x62, 0x6C, 0x76, 0x80, 0x8A, 0x94, 0x9E, 0xA8, 0xB2, 0xBC, 0xC6, 0xD0, 0xDA, 0xE4, 0xEE	// 240 - 255
};

void set_colors() { //trying to init all 256 colors
	(void)inportb(VGA_INSTAT_READ);

	outportb(VGA_DAC_WRITE, 0);
	for (size_t i = 0; i < 256; i++)
	{
		outportb(VGA_DAC_DATA, R[i] >> 2); // Red
		outportb(VGA_DAC_DATA, G[i] >> 2); // Green
		outportb(VGA_DAC_DATA, B[i] >> 2); // Blue
	}
	
}

void write_regs(unsigned char *regs)
{
	unsigned i;

/* write MISCELLANEOUS reg */
	outportb(VGA_MISC_WRITE, *regs);
	regs++;
/* write SEQUENCER regs */
	for(i = 0; i < VGA_NUM_SEQ_REGS; i++)
	{
		outportb(VGA_SEQ_INDEX, i);
		outportb(VGA_SEQ_DATA, *regs);
		regs++;
	}
/* unlock CRTC registers */
	outportb(VGA_CRTC_INDEX, 0x03);
	outportb(VGA_CRTC_DATA, inportb(VGA_CRTC_DATA) | 0x80);
	outportb(VGA_CRTC_INDEX, 0x11);
	outportb(VGA_CRTC_DATA, inportb(VGA_CRTC_DATA) & ~0x80);
/* make sure they remain unlocked */
	regs[0x03] |= 0x80;
	regs[0x11] &= ~0x80;
/* write CRTC regs */
	for(i = 0; i < VGA_NUM_CRTC_REGS; i++)
	{
		outportb(VGA_CRTC_INDEX, i);
		outportb(VGA_CRTC_DATA, *regs);
		regs++;
	}
/* write GRAPHICS CONTROLLER regs */
	for(i = 0; i < VGA_NUM_GC_REGS; i++)
	{
		outportb(VGA_GC_INDEX, i);
		outportb(VGA_GC_DATA, *regs);
		regs++;
	}
/* write ATTRIBUTE CONTROLLER regs */
	for(i = 0; i < VGA_NUM_AC_REGS; i++)
	{
		(void)inportb(VGA_INSTAT_READ);
		outportb(VGA_AC_INDEX, i);
		outportb(VGA_AC_WRITE, *regs);
		regs++;
	}
/* lock 16-color palette and unblank display */
	(void)inportb(VGA_INSTAT_READ);
	outportb(VGA_AC_INDEX, 0x20);	
}

void set_vga_graphics_mode_2() {
    write_regs(g_320x200x256);
	set_colors();
}

// Function to draw a pixel in mode 13h
void draw_pixel(int x, int y, unsigned short color) {
    unsigned short offset = x + 320 * y;
    unsigned char *VGA = (unsigned char *)VGA_FRAMEBUFFER;
    VGA[offset] = color;
}

// function to read a pixel from the screen and return its color
unsigned char read_pixel(int x, int y) {
	unsigned short offset = x + 320 * y;
    unsigned char *VGA = (unsigned char *)VGA_FRAMEBUFFER;
	unsigned char color = VGA[offset];
	return color;
}

/**
 * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 * vga text mode:
 * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

unsigned char g_80x25_text[] =
{
/* MISC */
	0x67,
/* SEQ */
	0x03, 0x00, 0x03, 0x00, 0x02,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x55, 0x81, 0xBF, 0x1F,
	0x00, 0x4F, 0x0D, 0x0E, 0x00, 0x00, 0x00, 0x50,
	0x9C, 0x0E, 0x8F, 0x28, 0x1F, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0E, 0x00,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x0C, 0x00, 0x0F, 0x08, 0x00
};

void set_vga_text_mode_2() {
    write_regs(g_80x25_text);
}


static const size_t VGA_WIDTH = 80;
static const size_t VGA_HEIGHT = 25;

size_t terminal_row;
size_t terminal_column;
uint8_t terminal_color;
uint16_t* terminal_buffer;

/* Create a VGA entry color */
static inline uint8_t vga_entry_color(enum vga_color fg, enum vga_color bg) 
{
	return fg | bg << 4;
}

/* Create a VGA entry with a character and color */
static inline uint16_t vga_entry(unsigned char uc, uint8_t color) 
{
	return (uint16_t) uc | (uint16_t) color << 8;
}

/* Initialize the terminal */
void terminal_initialize(void) 
{
	terminal_row = 0;
	terminal_column = 0;
	terminal_color = vga_entry_color(VGA_COLOR_LIGHT_GREEN, VGA_COLOR_BLACK);
	terminal_buffer = (uint16_t*) 0xB8000;
	for (size_t y = 0; y < VGA_HEIGHT; y++) {
		for (size_t x = 0; x < VGA_WIDTH; x++) {
			const size_t index = y * VGA_WIDTH + x;
			terminal_buffer[index] = vga_entry(' ', terminal_color);
		}
	}
}

/* Set the terminal text color */
void terminal_setcolor(uint8_t color) 
{
	terminal_color = color;
}

/* Place a character at a specific position on the terminal */
void terminal_putentryat(char c, uint8_t color, size_t x, size_t y) 
{
	const size_t index = y * VGA_WIDTH + x;
	terminal_buffer[index] = vga_entry(c, color);
}

/* Write a character to the terminal */
void terminal_putchar(char c) 
{
	terminal_putentryat(c, terminal_color, terminal_column, terminal_row);
	if (++terminal_column == VGA_WIDTH) {
		terminal_column = 0;
        if (++terminal_row == VGA_HEIGHT) {
            terminal_row = 0; // Wrap to the top.
        }
	}
}

/* write a string of a specific size to the terminal */
void terminal_write(const char* data, size_t size) 
{
	for (size_t i = 0; i < size; i++) {
		if (data[i] == '\n') {
			terminal_column = 0;
			terminal_row++;
			i++;
		}
		if (data[i] == '\t') {
			const char temp = ' '; 
			for (size_t k = 0; k < 4; k++) {
				terminal_putchar(temp);
			}
			i++;
			continue;
		}
		if (data[i] == '\r') {
			terminal_column = 0;
			i++;
		}
		if (i < size)
			terminal_putchar(data[i]);
	}
}

/* Write a null-terminated string to the terminal */
void terminal_writestring(const char * data) 
{
	terminal_write(data, strlen(data));
}

/* Print raw data to the terminal */
void print_data(void * data, size_t size) {
	unsigned char * ptr = (unsigned char *)data;
	terminal_write(ptr, size);
}

void clear_screen() { // technically doesn't really clear the screen so much as covering it in black.
	for (int x = 0; x < 320; x++)
	{
		for (int y = 0; y < 200; y++)
		{
			draw_pixel(x, y, 0x00);
		}
	}	
}  
